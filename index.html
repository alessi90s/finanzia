<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Quaderno Finanze - Import CSV</title>

  <!-- PapaParse (CDN) per leggere CSV lato browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
          integrity="sha512-jN4W0iv29oE6kp0YU4wUhL8T6d5Fz7d6DNj0O2oIbgVtzINsRmy1nPImRWyUZ+ht5/8BFH1lka60RKkTncYzvw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{--line:28px;--line-cl:#cdd7ee;--paper:#fbfcff;--ink:#1e293b;
          --green:#15803d;--red:#b91c1c;--lav:#d0d7e6;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Courier New",monospace}
    body{padding:2rem 1rem;background:repeating-linear-gradient(var(--paper)0 var(--line),
         var(--line-cl)var(--line)calc(var(--line)+1px));color:var(--ink)}
    h1{text-align:center;margin-bottom:2rem;font-size:2.2rem;text-transform:uppercase;letter-spacing:1px}
    h2{margin:1.2rem 0 0.5rem;font-size:1.25rem;text-decoration:underline double}
    .container{max-width:1200px;margin:0 auto}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:2rem}
    .card{background:#ffffffe0;border:1px solid #888;backdrop-filter:blur(2px);
          padding:1rem;border-radius:10px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .card h2{font-size:0.9rem;margin-bottom:0.15rem}
    .card p{font-size:1.4rem;font-weight:700}
    .positive{color:var(--green)} .negative{color:var(--red)}
    .badge{display:inline-block;padding:0.1rem 0.45rem;border-radius:4px;font-size:0.68rem;
           font-weight:700;text-transform:uppercase;color:#fff}
    .income{color:var(--green)} .expense{color:var(--red)}
    .badge.income{background:var(--green)} .badge.expense{background:var(--red)}
    table{width:100%;border-collapse:collapse;margin-bottom:2rem;background:#ffffffd0;
          border:1px solid #888;backdrop-filter:blur(2px)}
    thead{background:#343434;color:#fff} th,td{padding:0.55rem 0.6rem;text-align:center;font-size:0.9rem}
    tbody tr:nth-child(even){background:#f1f5f9dd}
    td.income::before{content:'+ ';font-weight:700;color:var(--green)}
    td.expense::before{content:'- ';font-weight:700;color:var(--red)}
    td.balance{font-weight:700} td.balance.positive{color:var(--green)} td.balance.negative{color:var(--red)}
    .month-sep td{background:var(--lav);font-weight:700;text-align:left;font-size:1rem;padding-left:0.4rem}
    #add-form,#csv-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.5rem;margin-bottom:2rem}
    input,select{padding:0.35rem;border:1px solid #888;border-radius:4px;background:#fff7}
    button{cursor:pointer;font-weight:700;background:var(--lav)}
  </style>
</head>
<body>
  <h1>Prospetto Entrate &amp; Uscite</h1>
  <div class="container">

    <!-- CARD riepilogo -->
    <section id="summary-cards" class="cards"></section>

    <!-- Import CSV -->
    <h2>Importa estratto CSV</h2>
    <form id="csv-form">
      <input type="file" id="csv-file" accept=".csv" />
      <select id="csv-signer">
        <option value="-">Segno (negativo = spesa)</option>
        <option value="reverse">Valori già firmati (es. -34,56)</option>
      </select>
      <button type="submit">Importa</button>
    </form>

    <!-- Add manuale -->
    <h2>Aggiungi transazione manuale</h2>
    <form id="add-form">
      <input type="date"   id="f-date" required />
      <input type="text"   id="f-cat"  placeholder="Categoria" required />
      <select id="f-type"><option>Entrata</option><option>Spesa</option></select>
      <input type="number" id="f-amt"  placeholder="Importo €" step="1" required />
      <button type="submit">Aggiungi</button>
    </form>

    <!-- Riepilogo mensile -->
    <h2>Riepilogo Mensile</h2>
    <table id="monthly-table"><thead><tr><th>Mese</th><th>Entrate</th><th>Uscite</th><th>Saldo</th></tr></thead><tbody></tbody></table>

    <!-- Dettaglio transazioni -->
    <h2>Dettaglio Transazioni</h2>
    <table id="transactions-table"><thead><tr><th>Data</th><th>Categoria</th><th>Tipo</th><th>Importo</th><th>Saldo</th></tr></thead><tbody></tbody></table>
  </div>

<script>
/* ---------- CONFIG BASE ---------- */
const START_BALANCE = 6100;
const START_DATE    = new Date('2025-06-24');
const END_DATE      = new Date('2026-12-31');
const lastDay=(y,m)=>new Date(y,m+1,0).getDate();

/* ---------- Dataset statico (abbrev.) ---------- */
const SUBS=[['Netflix',19,26,'2025-06'],['Will',7,28,'2025-06'],['ChatGPT',23,22,'2025-06']];
const ONE_OFF=[['2025-06-27','Aereo',53,'Spesa']];
const LOAN   =['2025-07-01'].map(d=>[d,'Finanziamento',39,'Spesa']);

/* ---------- Array transazioni ---------- */
let tx=[];
const push=(d,c,t,a)=>tx.push({date:d,category:c,type:t,amount:a});

[...ONE_OFF,...LOAN].forEach(([d,c,a,t])=>push(d,c,t,a));

/* Genera dinamiche (affitto, ecc.) solo per DEMO ridotte */
push('2025-07-01','Stipendio','Entrata',1650);
push('2025-07-31','Affitto','Spesa',680);

/* ---------- UTIL ---------- */
const fmt=v=>`€ ${Math.round(v).toLocaleString('it-IT')}`;
let monthly={},running;

const calc=()=>{
  tx.sort((a,b)=>new Date(a.date)-new Date(b.date));
  running=START_BALANCE; monthly={};
  tx.forEach(t=>{
    running += t.type==='Entrata'? t.amount : -t.amount;
    t.balance=running;
    const k=t.date.slice(0,7);
    monthly[k]??={in:0,out:0,s:0};
    t.type==='Entrata'?monthly[k].in+=t.amount:monthly[k].out+=t.amount;
    monthly[k].s=running;
  });
};

const render=()=>{
  calc();
  /* Cards */
  document.getElementById('summary-cards').innerHTML='';
  const totIn = Object.values(monthly).reduce((s,m)=>s+m.in,0),
        totOut= Object.values(monthly).reduce((s,m)=>s+m.out,0),
        avgOut= Math.round(totOut/Object.keys(monthly).length);
  [['Saldo iniziale',START_BALANCE,''],['Entrate',totIn,'positive'],
   ['Uscite',totOut,'negative'],['Media spese',avgOut,'negative'],
   ['Saldo',running,running>=0?'positive':'negative']]
  .forEach(([l,v,cls])=>{
    const d=document.createElement('div');d.className='card';
    d.innerHTML=`<h2>${l}</h2><p class='${cls}'>${fmt(v)}</p>`;document.getElementById('summary-cards').appendChild(d);});

  /* Monthly table */
  const mBody=document.querySelector('#monthly-table tbody');mBody.innerHTML='';
  Object.keys(monthly).sort().forEach(k=>{
    const {in:inn,out,s}=monthly[k];
    mBody.insertAdjacentHTML('beforeend',
    `<tr><td>${k}</td><td class='income'>${fmt(inn)}</td><td class='expense'>${fmt(out)}</td><td class='balance ${s>=0?'positive':'negative'}'>${fmt(s)}</td></tr>`);});

  /* Transactions */
  const tBody=document.querySelector('#transactions-table tbody');tBody.innerHTML='';
  let cur='';tx.forEach(t=>{
    const m=t.date.slice(0,7);
    if(m!==cur){cur=m;const label=new Date(`${m}-01`).toLocaleDateString('it-IT',{month:'long',year:'numeric'});
      tBody.insertAdjacentHTML('beforeend',`<tr class='month-sep'><td colspan='5'>${label.charAt(0).toUpperCase()+label.slice(1)}</td></tr>`);}
    tBody.insertAdjacentHTML('beforeend',
      `<tr><td>${t.date}</td><td>${t.category}</td>
       <td><span class='badge ${t.type==='Entrata'?'income':'expense'}'>${t.type}</span></td>
       <td class='${t.type==='Entrata'?'income':'expense'}'>${fmt(t.amount)}</td>
       <td class='balance ${t.balance>=0?'positive':'negative'}'>${fmt(t.balance)}</td></tr>`);});
};
render();

/* ---------- FORM MANUALE ---------- */
document.getElementById('add-form').addEventListener('submit',e=>{
  e.preventDefault();
  const d=document.getElementById('f-date').value,
        c=document.getElementById('f-cat').value||'Varie',
        t=document.getElementById('f-type').value,
        a=parseFloat(document.getElementById('f-amt').value);
  push(d,c,t,a); e.target.reset(); render();
});

/* ---------- IMPORT CSV ---------- */
document.getElementById('csv-form').addEventListener('submit',e=>{
  e.preventDefault();
  const file=document.getElementById('csv-file').files[0];
  if(!file){alert('Seleziona un file CSV');return;}
  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      /* Mappa colonne: personalizza qui se necessario */
      res.data.forEach(row=>{
        const rawDate  = row['Date']||row['Data']||row['date'],
              rawDesc  = row['Description']||row['Descrizione']||row['description']||'Banca',
              rawAmount= parseFloat(row['Amount']||row['Importo']||row['amount']);
        if(!rawDate || isNaN(rawAmount)) return;
        const type = rawAmount>=0 ? 'Entrata' : 'Spesa';
        push(rawDate, rawDesc.trim(), type, Math.abs(rawAmount));
      });
      render();
      alert('Import CSV completato!');
      document.getElementById('csv-form').reset();
    }});
});
</script>
</body>
</html>
