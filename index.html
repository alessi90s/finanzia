<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Mensile + Tracker + Pianificazione</title>
<style>
:root{ --ink:#1e293b; --muted:#64748b; --ok:#16a34a; --bad:#b91c1c; --accent:#4a67d6;
  --card:#ffffff; --bg:#f4f6fb; --line:#e2e8f0; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
h1,h2{margin:0 0 14px}
h1{text-align:center;margin:16px 0}
.container{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
.card h3{margin:0 0 10px;font-size:15px;color:var(--muted);letter-spacing:.2px;text-transform:uppercase}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
label{font-size:13px;color:var(--muted)}
input[type="number"],input[type="text"],input[type="date"],input[type="month"],select{
  width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:14px}
button{padding:10px 14px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:14px;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{flex:1 1 180px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;text-align:center}
.kpi .pill .v{font-weight:800;font-size:18px}
.ok{color:var(--ok)} .bad{color:var(--bad)}
small.hint{color:var(--muted)}
hr{border:none;border-top:1px dashed var(--line);margin:10px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff}
.badge.neutral{background:#334155} .badge.ok{background:var(--ok)} .badge.bad{background:var(--bad)}
.progress{height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden}
.progress > div{height:100%;background:var(--accent)}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
.tbl th{color:#0f172a;background:#f8fafc}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
@media (max-width: 760px){
  .grid{grid-template-columns:1fr}
  .row{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <h1>Budget Mensile + Tracker + Pianificazione</h1>
  <div class="container">

    <!-- Mese + saldi -->
    <div class="grid">
      <div class="card" style="grid-column: span 6;">
        <h3>Mese</h3>
        <div class="row">
          <div>
            <label>Mese</label>
            <input type="month" id="mese">
          </div>
          <div>
            <label>Saldo iniziale conto (€)</label>
            <input type="number" id="saldo_iniziale" step="0.01" value="196" oninput="updateAll()">
            <small class="hint">Esempio iniziale: 318 - 122 = 196</small>
          </div>
        </div>
      </div>
      <div class="card" style="grid-column: span 6;">
        <h3>Risparmi</h3>
        <div class="row">
          <div>
            <label>Risparmi accumulati (€)</label>
            <input type="number" id="risparmi" step="0.01" value="3500" oninput="saveGlobal()">
          </div>
          <div>
            <label>Saldo fine mese (proiezione)</label>
            <input type="text" id="saldo_fine" readonly>
          </div>
        </div>
        <small class="hint">I risparmi stanno separati dal conto. Con “Chiudi mese” puoi spostare il risparmio.</small>
      </div>
    </div>

    <div class="grid">
      <!-- Entrate -->
      <div class="card" style="grid-column: span 6;">
        <h3>Entrate</h3>
        <div class="row">
          <div>
            <label>Entrate totali (€)</label>
            <input type="number" id="entrate" step="0.01" value="1681" oninput="updateAll()">
          </div>
          <div>
            <label>Risparmio del mese (€)</label>
            <input type="number" id="risparmio" step="0.01" value="200" oninput="updateAll()">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Azione risparmio alla chiusura</label>
            <select id="azione_risparmio">
              <option value="to_savings">Trasferisci a risparmi (− conto, + risparmi)</option>
              <option value="to_account">Aggiungi al conto (+ conto)</option>
            </select>
          </div>
          <div style="display:flex;align-items:end;gap:8px;">
            <button class="primary" type="button" onclick="chiudiMese()">Chiudi mese</button>
          </div>
        </div>
        <small class="hint">“Chiudi mese” applica l’azione sul risparmio e porta il saldo fine come saldo iniziale del mese successivo.</small>
      </div>

      <!-- Spese fisse -->
      <div class="card" style="grid-column: span 6;">
        <h3>Spese fisse (mensili)</h3>
        <div class="row">
          <div>
            <label>Affitto</label><input type="number" id="affitto" step="0.01" value="680" oninput="updateAll()">
            <label>Netflix</label><input type="number" id="netflix" step="0.01" value="7" oninput="updateAll()">
            <label>ATM</label><input type="number" id="atm" step="0.01" value="39" oninput="updateAll()">
            <label>YouTube</label><input type="text" id="youtube" value="9,99" oninput="updateAll()">
          </div>
          <div>
            <label>Spotify</label><input type="number" id="spotify" step="0.01" value="21" oninput="updateAll()">
            <label>Prime (AD+Std)</label><input type="number" id="prime" step="0.01" value="7" oninput="updateAll()">
            <label>iCloud</label><input type="number" id="icloud" step="0.01" value="10" oninput="updateAll()">
            <label>ChatGPT</label><input type="number" id="chatgpt" step="0.01" value="23" oninput="updateAll()">
          </div>
        </div>
        <div class="row">
          <div>
            <label>iPad (rata mensile)</label>
            <input type="number" id="ipad" step="0.01" value="38.28" oninput="updateAll()">
          </div>
          <div>
            <label>Spese variabili (cibo, benzina…)</label>
            <input type="number" id="variabili" step="0.01" value="0" oninput="updateAll()">
          </div>
        </div>
        <hr>
        <small class="hint">Rate automatiche extra: +83 € a <b>Novembre</b> e +83 € a <b>Dicembre</b>. Inoltre puoi aggiungere “Extra pianificati” sotto.</small>
      </div>

      <!-- KPI -->
      <div class="card" style="grid-column: span 12;">
        <h3>Riepilogo</h3>
        <div class="kpi">
          <div class="pill"><div>Spese fisse</div><div class="v" id="k_fisse">€ 0,00</div></div>
          <div class="pill"><div>Spese variabili</div><div class="v" id="k_var">€ 0,00</div></div>
          <div class="pill"><div>Risparmio</div><div class="v" id="k_save">€ 0,00</div></div>
          <div class="pill"><div>Rate/Extra mese</div><div class="v" id="k_rate">€ 0,00</div></div>
          <div class="pill"><div>Residuo disponibile</div><div class="v" id="k_residuo">€ 0,00</div></div>
        </div>
      </div>

      <!-- Allocazione residuo -->
      <div class="card" style="grid-column: span 12;">
        <h3>Dividi il residuo in “buste”</h3>
        <div class="flex" style="margin-bottom:10px;">
          <label><input type="radio" name="mode" value="percent" checked onchange="toggleMode();updateAll()"> Percentuale</label>
          <label><input type="radio" name="mode" value="euro" onchange="toggleMode();updateAll()"> Importi fissi (€)</label>
          <button type="button" onclick="resetDefault()">Ripristina default</button>
        </div>

        <!-- Percentuale -->
        <div id="box-percent">
          <div class="row">
            <div>
              <label>Spesa (%)</label>
              <input type="range" id="p_spesa" min="0" max="100" value="40" oninput="syncRange('spesa')">
              <input type="number" id="n_spesa" min="0" max="100" value="40" oninput="syncNumber('spesa')">
            </div>
            <div>
              <label>Divertimento (%)</label>
              <input type="range" id="p_div" min="0" max="100" value="40" oninput="syncRange('div')">
              <input type="number" id="n_div" min="0" max="100" value="40" oninput="syncNumber('div')">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Extra (%)</label>
              <input type="range" id="p_extra" min="0" max="100" value="20" oninput="syncRange('extra')">
              <input type="number" id="n_extra" min="0" max="100" value="20" oninput="syncNumber('extra')">
            </div>
            <div style="display:flex;align-items:end"><small class="hint" id="sumHint">Somma 100% (adesso 100%).</small></div>
          </div>
        </div>

        <!-- Euro -->
        <div id="box-euro" style="display:none; margin-top:6px;">
          <div class="row">
            <div>
              <label>Spesa (€)</label>
              <div class="progress"><div id="bar_e_spesa" style="width:0%"></div></div>
              <input type="number" id="e_spesa" step="0.01" value="0" oninput="updateAll()">
            </div>
            <div>
              <label>Divertimento (€)</label>
              <div class="progress"><div id="bar_e_div" style="width:0%"></div></div>
              <input type="number" id="e_div" step="0.01" value="0" oninput="updateAll()">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Extra (€)</label>
              <div class="progress"><div id="bar_e_extra" style="width:0%"></div></div>
              <input type="number" id="e_extra" step="0.01" value="0" oninput="updateAll()">
            </div>
          </div>
        </div>

        <hr>
        <div class="row">
          <div>
            <div><span class="badge neutral">Spesa</span> <b id="out_spesa">€ 0,00</b></div>
            <div><span class="badge neutral">Divertimento</span> <b id="out_div">€ 0,00</b></div>
            <div><span class="badge neutral">Extra</span> <b id="out_extra">€ 0,00</b></div>
          </div>
          <div>
            <div>Residuo dopo buste: <b id="out_residuo" class="ok">€ 0,00</b></div>
            <div id="warn_deficit" class="bad" style="display:none;margin-top:6px;">Hai allocato più del residuo.</div>
          </div>
        </div>
      </div>

      <!-- TRACKER SETTIMANALE -->
      <div class="card" style="grid-column: span 12;">
        <h3>Tracker settimanale</h3>
        <small class="hint">Registra quanto spendi in <b>Spesa</b>, <b>Divertimento</b>, <b>Extra</b>. Confronto con budget settimanale del mese.</small>
        <hr>
        <div class="row">
          <div>
            <label>Data</label>
            <input type="date" id="t_data">
          </div>
          <div>
            <label>Categoria</label>
            <select id="t_cat">
              <option>Spesa</option>
              <option>Divertimento</option>
              <option>Extra</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Importo (€)</label>
            <input type="number" id="t_importo" step="0.01" placeholder="0.00">
          </div>
          <div style="display:flex;align-items:end;gap:8px;">
            <button class="primary" type="button" onclick="addTxn()">Aggiungi spesa</button>
            <button type="button" onclick="clearMonth()">Svuota mese</button>
          </div>
        </div>

        <hr>
        <div class="kpi" id="wk_kpi"></div>

        <div style="margin-top:8px;overflow:auto">
          <table class="tbl" id="tbl_txn">
            <thead><tr><th>Settimana</th><th>Data</th><th>Categoria</th><th>Importo</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- PIANIFICAZIONE MESI -->
      <div class="card" style="grid-column: span 12;">
        <h3>Pianifica mesi</h3>
        <small class="hint">Copia le impostazioni correnti su più mesi e aggiungi extra pianificati (una tantum).</small>
        <hr>
        <div class="row">
          <div>
            <label>Da mese</label>
            <input type="month" id="plan_from">
          </div>
          <div>
            <label>A mese</label>
            <input type="month" id="plan_to">
          </div>
        </div>
        <div class="row">
          <div class="flex">
            <label><input type="checkbox" id="plan_copy_income" checked> Copia entrate & risparmio</label>
            <label><input type="checkbox" id="plan_copy_fixed" checked> Copia spese fisse</label>
            <label><input type="checkbox" id="plan_copy_var" checked> Copia spese variabili</label>
          </div>
          <div style="display:flex;align-items:end;">
            <button type="button" onclick="applyPlan()">Applica piano ai mesi</button>
          </div>
        </div>

        <hr>
        <h4>Extra pianificati (una tantum)</h4>
        <div class="row">
          <div>
            <label>Mese</label><input type="month" id="px_mese">
          </div>
          <div>
            <label>Descrizione</label><input type="text" id="px_desc" placeholder="Es. Bollo auto">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Importo (€)</label><input type="number" id="px_importo" step="0.01" placeholder="0.00">
          </div>
          <div style="display:flex;align-items:end;">
            <button type="button" onclick="addPlannedExtra()">Aggiungi extra</button>
          </div>
        </div>
        <div style="margin-top:8px;overflow:auto">
          <table class="tbl" id="tbl_px">
            <thead><tr><th>Mese</th><th>Descrizione</th><th>Importo</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <small class="hint">Gli extra pianificati vengono sommati alla colonna “Rate/Extra mese” quando selezioni quel mese.</small>
      </div>

    </div>
  </div>

<script>
/* ====== Utils ====== */
const euro = n => "€ " + Number(n||0).toFixed(2).replace(".",",");
const getN = id => { const el=document.getElementById(id); const raw=(el?.value||"").toString().replace(",","."); const v=parseFloat(raw); return isNaN(v)?0:v; };
const todayISO = ()=> new Date().toISOString().slice(0,10);
const monthISO = d => d.slice(0,7);
const daysInMonth=(y,m)=> new Date(y,m+1,0).getDate();

/* settimane del mese (lun-dom) */
function monthWeeks(ym){
  const [Y,M]=ym.split("-").map(Number); const y=Y, m=M-1;
  const first = new Date(y,m,1);
  const last  = new Date(y,m,daysInMonth(y,m));
  const start = new Date(first); start.setDate(first.getDate() - ((first.getDay()+6)%7));
  const end = new Date(last);   end.setDate(last.getDate() + (7-((last.getDay()+6)%7)-1));
  const out=[];
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+7)){
    const s=new Date(d), e=new Date(d); e.setDate(e.getDate()+6);
    out.push({start:s,end:e});
  }
  return out;
}
function weekIndexForDate(ym, dateStr){
  const weeks=monthWeeks(ym); const d=new Date(dateStr);
  for(let i=0;i<weeks.length;i++) if(d>=weeks[i].start && d<=weeks[i].end) return i+1;
  return 1;
}

/* ==== LocalStorage ==== */
const GLOBAL_KEY='budget_global_v1';          // { risparmi }
const MONTH_KEY = m => 'budget_month_'+m;     // stato mese (inputs base)
const ALLOC_KEY = m => 'budget_alloc_'+m;     // {spesa,div,extra}
const TXN_KEY   = m => 'budget_txn_'+m;       // [{...}]
const PX_KEY    = 'budget_planned_extras_v1'; // [{m, desc, amt, id}]

function saveGlobal(){
  const g={ risparmi: getN('risparmi') };
  localStorage.setItem(GLOBAL_KEY, JSON.stringify(g));
}
function loadGlobal(){
  try{ const g=JSON.parse(localStorage.getItem(GLOBAL_KEY)||'{}'); if(g.risparmi!=null){ document.getElementById('risparmi').value=g.risparmi; } }catch(e){}
}

function saveMonthState(m){
  const st={
    saldo_iniziale:getN('saldo_iniziale'), entrate:getN('entrate'), risparmio:getN('risparmio'),
    affitto:getN('affitto'), netflix:getN('netflix'), atm:getN('atm'), youtube:document.getElementById('youtube').value,
    spotify:getN('spotify'), prime:getN('prime'), icloud:getN('icloud'), chatgpt:getN('chatgpt'),
    ipad:getN('ipad'), variabili:getN('variabili'), azione_risparmio:document.getElementById('azione_risparmio').value
  };
  localStorage.setItem(MONTH_KEY(m), JSON.stringify(st));
}
function loadMonthState(m){
  try{
    const st=JSON.parse(localStorage.getItem(MONTH_KEY(m))||'{}');
    for(const k in st){
      if(k==='youtube') document.getElementById(k).value=st[k];
      else if(document.getElementById(k)) document.getElementById(k).value=st[k];
    }
    if(st.azione_risparmio) document.getElementById('azione_risparmio').value=st.azione_risparmio;
  }catch(e){}
}
function saveAlloc(m, alloc){ localStorage.setItem(ALLOC_KEY(m), JSON.stringify(alloc)); }
function loadAlloc(m){ try{ return JSON.parse(localStorage.getItem(ALLOC_KEY(m))||"{}"); }catch(e){return {};}}
function loadTxn(m){ try{ return JSON.parse(localStorage.getItem(TXN_KEY(m))||"[]"); }catch(e){return [];}}
function saveTxn(m, arr){ localStorage.setItem(TXN_KEY(m), JSON.stringify(arr)); }
function loadPlannedExtras(){
  try{ return JSON.parse(localStorage.getItem(PX_KEY)||"[]"); }catch(e){return [];}
}
function savePlannedExtras(list){ localStorage.setItem(PX_KEY, JSON.stringify(list)); }

/* ==== rate automatiche ==== */
function extraRateForMonth(ym){ return (/-11$/.test(ym) || /-12$/.test(ym)) ? 83 : 0; }

/* ==== extra pianificati – UI ==== */
function addPlannedExtra(){
  const m=document.getElementById('px_mese').value;
  const desc=(document.getElementById('px_desc').value||'').trim();
  const amt=getN('px_importo');
  if(!m || !desc || !amt){ alert('Completa mese, descrizione e importo.'); return; }
  const list=loadPlannedExtras();
  list.push({id:Date.now(), m, desc, amt});
  savePlannedExtras(list);
  document.getElementById('px_desc').value='';
  document.getElementById('px_importo').value='';
  renderPlannedExtras();
  updateAll();
}
function delPlannedExtra(id){
  let list=loadPlannedExtras().filter(x=>x.id!==id);
  savePlannedExtras(list);
  renderPlannedExtras();
  updateAll();
}
function renderPlannedExtras(){
  const tbody=document.querySelector('#tbl_px tbody');
  const list=loadPlannedExtras().sort((a,b)=>a.m.localeCompare(b.m));
  tbody.innerHTML='';
  list.forEach(x=>{
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${x.m}</td><td>${x.desc}</td><td>${euro(x.amt)}</td><td><button onclick="delPlannedExtra(${x.id})">✕</button></td></tr>`);
  });
}

/* ==== calcoli base & allocazione ==== */
function toggleMode(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  document.getElementById("box-percent").style.display = mode==="percent" ? "block" : "none";
  document.getElementById("box-euro").style.display    = mode==="euro"    ? "block" : "none";
}
function plannedExtrasForMonth(m){
  return loadPlannedExtras().filter(x=>x.m===m).reduce((s,x)=>s+Number(x.amt||0),0);
}
function calcolaBase(){
  const m = document.getElementById("mese").value;
  // salva stato del mese
  saveMonthState(m);

  const saldoIni = getN("saldo_iniziale");
  const entrate  = getN("entrate");
  const risparmio= getN("risparmio");
  const fisse = getN("affitto")+getN("netflix")+getN("atm")+getN("youtube")+getN("spotify")+getN("prime")+getN("icloud")+getN("chatgpt")+getN("ipad");
  const variabili=getN("variabili");
  const rateAuto = extraRateForMonth(m);
  const extraPlan = plannedExtrasForMonth(m);
  const rateMese = rateAuto + extraPlan;

  const residuo=entrate-(fisse+variabili+risparmio+rateMese);
  const saldoFine = saldoIni + residuo;

  document.getElementById("k_fisse").textContent   = euro(fisse);
  document.getElementById("k_var").textContent     = euro(variabili);
  document.getElementById("k_save").textContent    = euro(risparmio);
  document.getElementById("k_rate").textContent    = euro(rateMese);
  document.getElementById("k_residuo").textContent = euro(residuo);
  document.getElementById("saldo_fine").value      = euro(saldoFine);

  return {residuo, saldoFine};
}
function updateAll(){
  const {residuo} = calcolaBase();
  const mode=document.querySelector('input[name="mode"]:checked').value;

  let spesa=0,div=0,extra=0;
  if(mode==="percent"){
    const p1=getN("p_spesa"), p2=getN("p_div"), p3=getN("p_extra");
    const sum = p1+p2+p3;
    document.getElementById("sumHint").textContent = `Somma 100% (adesso ${sum.toFixed(0)}%).`;
    const w1=sum>0?p1/sum:0, w2=sum>0?p2/sum:0, w3=sum>0?p3/sum:0;
    spesa=Math.max(0,residuo)*w1; div=Math.max(0,residuo)*w2; extra=Math.max(0,residuo)*w3;
  }else{
    spesa=getN("e_spesa"); div=getN("e_div"); extra=getN("e_extra");
    const tot=Math.max(0,residuo), sum=spesa+div+extra, deficit=sum-tot;
    const pct=x=> tot>0? Math.min(100, Math.round((x/tot)*100)) : 0;
    document.getElementById("bar_e_spesa").style.width=pct(spesa)+"%";
    document.getElementById("bar_e_div").style.width  =pct(div)+"%";
    document.getElementById("bar_e_extra").style.width=pct(extra)+"%";
    if(deficit>0){ document.getElementById("out_residuo").textContent=euro(-deficit); document.getElementById("out_residuo").className="bad"; document.getElementById("warn_deficit").style.display="block"; }
    else{ document.getElementById("out_residuo").textContent=euro(tot-sum); document.getElementById("out_residuo").className="ok"; document.getElementById("warn_deficit").style.display="none"; }
  }
  document.getElementById("out_spesa").textContent=euro(spesa);
  document.getElementById("out_div").textContent  =euro(div);
  document.getElementById("out_extra").textContent=euro(extra);

  // salva allocazione del mese per tracker
  const m=document.getElementById("mese").value;
  saveAlloc(m,{spesa,div,extra});
  renderTracker();
}

/* ==== Chiudi mese (applica il risparmio e avanza al successivo) ==== */
function nextMonth(ym){
  const [Y,M]=ym.split('-').map(Number);
  const d=new Date(Y, M-1, 1); d.setMonth(d.getMonth()+1);
  return d.toISOString().slice(0,7);
}
function chiudiMese(){
  const m=document.getElementById('mese').value;
  const azione=document.getElementById('azione_risparmio').value;
  const risp=getN('risparmio');
  const saldoFineTxt=document.getElementById('saldo_fine').value.replace('€','').trim().replace('.','').replace(',','.');
  const saldoFine=parseFloat(saldoFineTxt)||0;

  // aggiorna conti globali
  let risparmi=getN('risparmi');
  let saldoConto = saldoFine;
  if(azione==='to_savings'){
    risparmi += risp;       // + risparmio in salvadanaio
    saldoConto -= risp;     // - dal conto (trasferimento)
  }else{
    saldoConto += risp;     // + sul conto (se lo tratti come entrata extra)
  }
  document.getElementById('risparmi').value=risparmi;
  document.getElementById('saldo_iniziale').value=saldoConto; // per mese successivo
  saveGlobal();

  // passa al mese successivo mantenendo gli stessi valori (se già pianificati, verranno caricati)
  const nm = nextMonth(m);
  document.getElementById('mese').value = nm;
  // se c'è stato un piano salvato per quel mese, lo ricarichiamo; altrimenti restano gli stessi input appena aggiornati
  loadMonthState(nm);
  updateAll();
  renderTracker();
  alert('Mese chiuso. Saldo e risparmi aggiornati. Sei passato a '+nm+'.');
}

/* ====== Tracker ====== */
function addTxn(){
  const m=document.getElementById("mese").value;
  const d=document.getElementById("t_data").value || todayISO();
  if(monthISO(d)!==m){ alert("La data non appartiene al mese selezionato."); return; }
  const cat=document.getElementById("t_cat").value;
  const amt=getN("t_importo");
  if(!amt){ alert("Inserisci un importo valido."); return; }
  const list=loadTxn(m);
  const id=Date.now();
  list.push({id,date:d,cat,amt});
  list.sort((a,b)=> new Date(a.date)-new Date(b.date));
  saveTxn(m,list);
  document.getElementById("t_importo").value="";
  renderTracker();
}
function delTxn(id){
  const m=document.getElementById("mese").value;
  let list=loadTxn(m).filter(x=>x.id!==id);
  saveTxn(m,list);
  renderTracker();
}
function clearMonth(){
  const m=document.getElementById("mese").value;
  if(confirm("Cancellare tutte le spese registrate per "+m+"?")){
    saveTxn(m,[]);
    renderTracker();
  }
}
function renderTracker(){
  const m=document.getElementById("mese").value;
  const alloc=loadAlloc(m);
  const list=loadTxn(m);
  const weeks=monthWeeks(m);
  const today=new Date(), ymToday=today.toISOString().slice(0,7);
  const nowWeek = (ymToday!==m)? weeks.length : weekIndexForDate(m, todayISO());

  const by = {
    Spesa: {monthly:alloc.spesa||0},
    Divertimento: {monthly:alloc.div||0},
    Extra: {monthly:alloc.extra||0},
  };
  const nWeeks=weeks.length;
  for(const k in by){ by[k].perWeek = (by[k].monthly||0)/nWeeks; }

  const spentToWeek = {Spesa:0, Divertimento:0, Extra:0};
  list.forEach(t=>{ const w=weekIndexForDate(m,t.date); if(w<=nowWeek) spentToWeek[t.cat]+= Number(t.amt||0); });

  const kpi=document.getElementById("wk_kpi"); kpi.innerHTML="";
  ["Spesa","Divertimento","Extra"].forEach(cat=>{
    const allowed = by[cat].perWeek * nowWeek;
    const diff = allowed - spentToWeek[cat];
    const cls = diff>=0? "ok":"bad";
    const pctBase = by[cat].monthly>0 ? Math.min(100, Math.round((spentToWeek[cat]/by[cat].monthly)*100)) : 0;
    kpi.insertAdjacentHTML("beforeend", `
      <div class="pill" style="min-width:220px">
        <div style="font-weight:700">${cat}</div>
        <div style="font-size:12px;color:#64748b">Mese: ${euro(by[cat].monthly)} · ${nWeeks} sett. · /sett: ${euro(by[cat].perWeek)}</div>
        <div style="margin-top:6px" class="progress"><div style="width:${pctBase}%"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:13px">
          <span>Speso finora: <b>${euro(spentToWeek[cat])}</b></span>
          <span>Potevi: <b>${euro(allowed)}</b></span>
        </div>
        <div class="${cls}" style="margin-top:4px">Scostamento: <b>${euro(diff)}</b></div>
      </div>
    `);
  });

  const tbody=document.querySelector("#tbl_txn tbody"); tbody.innerHTML="";
  list.forEach(t=>{
    const w=weekIndexForDate(m,t.date);
    tbody.insertAdjacentHTML("beforeend",
      `<tr>
        <td>Sett. ${w}</td>
        <td>${t.date}</td>
        <td>${t.cat}</td>
        <td>${euro(t.amt)}</td>
        <td><button onclick="delTxn(${t.id})">✕</button></td>
      </tr>`);
  });
}

/* ===== Pianifica mesi – copia impostazioni ===== */
function monthRange(from,to){
  const out=[]; if(!from||!to) return out;
  const [Y1,M1]=from.split('-').map(Number);
  const [Y2,M2]=to.split('-').map(Number);
  let d=new Date(Y1,M1-1,1), end=new Date(Y2,M2-1,1);
  while(d<=end){ out.push(d.toISOString().slice(0,7)); d.setMonth(d.getMonth()+1); }
  return out;
}
function applyPlan(){
  const from=document.getElementById('plan_from').value;
  const to=document.getElementById('plan_to').value;
  const months=monthRange(from,to);
  if(months.length===0){ alert('Seleziona un intervallo valido.'); return; }

  const copyIncome=document.getElementById('plan_copy_income').checked;
  const copyFixed =document.getElementById('plan_copy_fixed').checked;
  const copyVar   =document.getElementById('plan_copy_var').checked;

  // prendi stato corrente come template
  const tpl = JSON.parse(localStorage.getItem(MONTH_KEY(document.getElementById('mese').value))||'{}');
  months.forEach(m=>{
    const st=JSON.parse(localStorage.getItem(MONTH_KEY(m))||'{}');
    if(copyIncome){ st.entrate=tpl.entrate; st.risparmio=tpl.risparmio; st.azione_risparmio=tpl.azione_risparmio||'to_savings'; }
    if(copyFixed){
      ['affitto','netflix','atm','youtube','spotify','prime','icloud','chatgpt','ipad'].forEach(k=> st[k]=tpl[k]);
    }
    if(copyVar){ st.variabili=tpl.variabili; }
    // saldo_iniziale lo lasciamo invariato (sarà aggiornato da “Chiudi mese” mese per mese)
    localStorage.setItem(MONTH_KEY(m), JSON.stringify(st));
  });
  alert('Piano applicato a '+months.length+' mese/i.');
}

/* ==== Boot ==== */
(function init(){
  const today = todayISO();
  const m = monthISO(today);
  document.getElementById("mese").value = m;
  document.getElementById("t_data").value = today;

  // pianificazione default date picker
  document.getElementById('plan_from').value = m;
  document.getElementById('plan_to').value = m;

  loadGlobal();
  loadMonthState(m);
  renderPlannedExtras();
  toggleMode();
  updateAll();

  document.getElementById("mese").addEventListener("change", ()=>{
    const mm=document.getElementById("mese").value;
    loadMonthState(mm);
    updateAll();
    renderTracker();
  });
})();
</script>
</body>
</html>
