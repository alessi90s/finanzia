<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Finanze – Dashboard & Import XLSX</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<style>
/* … (STILE identico alla versione precedente – omesso qui per brevità) … */
</style>
</head>
<body>
<!-- … (struttura HTML identica: card, import, tabelle, form) … -->
<!-- … COPIA il blocco <div class="container"> e tutti gli elementi come prima … -->

<script>
/* ====== CONFIG & UTIL ====== */
const START_BALANCE = 6100;
const fmt = v => `€ ${Math.round(v).toLocaleString('it-IT')}`;
const monthKey = d => d.slice(0,7);
const lastDay  = (y,m)=>new Date(y,m+1,0).getDate();

/* ====== GENERA SPESE FISSE (dal 2025-07 al 2026-12) ====== */
/* … (stesso codice di generazione che già funzionava) … */

/* ======  STATO  ====== */
let tx = [];           // transazioni fisse + manuali
let extraMonthly={};   // totali da XLSX {aaaa-mm:{in,out}}

/* (funzioni generateFixed(), render(), form manuale – COME NELLA VERSIONE PRECEDENTE) */

/* ====== IMPORT XLSX ROBUSTO ====== */
document.getElementById('xlsx-form').addEventListener('submit',e=>{
  e.preventDefault();
  const file=document.getElementById('xlsx-file').files[0];
  if(!file){alert('Seleziona un file XLSX');return;}

  const reader=new FileReader();
  reader.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});

    /* --- trova la PRIMA riga che abbia una data + un numero --- */
    let dateCol=-1, amtCol=-1;
    for(const row of rows){
      row.forEach((cell,idx)=>{
        /* se non ancora trovata colonna data: verifica formato Excel o ISO/italiano */
        if(dateCol===-1){
          if(typeof cell==='number' && XLSX.SSF.is_date(ws['!cols']?.[idx]?.w||'')) dateCol=idx;
          else if(typeof cell==='string' && /^\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}$/.test(cell.trim())) dateCol=idx;
        }
        /* se non ancora colonna importo: cerca un numero con , o . */
        if(amtCol===-1 && /[-]?\d/.test(cell)){
          const num=parseFloat(cell.toString().replace(/\./g,'').replace(',','.'));
          if(!isNaN(num)) amtCol=idx;
        }
      });
      if(dateCol!==-1 && amtCol!==-1) break;
    }
    if(dateCol===-1||amtCol===-1){alert('Colonne data/importo non trovate');return;}

    extraMonthly={};

    /* --- scorri tutte le righe utili --- */
    rows.forEach((r,i)=>{
      if(i===0) return; // salta header già analizzato
      const rawDate=r[dateCol], rawAmt=r[amtCol];
      if(!rawDate||rawAmt==='') return;

      /* parse data */
      let iso;
      if(typeof rawDate==='number') iso=XLSX.SSF.format('yyyy-mm-dd',rawDate);
      else{
        const parts=rawDate.toString().trim().replace(/\./g,'/').split(/[\/\-]/);
        if(parts.length<3) return;
        const [d,m,y]=parts;
        iso=`${y.length===2?'20'+y:y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      }

      /* parse importo */
      const amt=parseFloat(rawAmt.toString().replace(/\s|€|\./g,'').replace(',','.'));
      if(isNaN(amt)) return;

      const mk=monthKey(iso);
      extraMonthly[mk]??={in:0,out:0};
      amt>=0? extraMonthly[mk].in  +=  amt
             : extraMonthly[mk].out += -amt;
    });

    render();
    alert('Import XLSX riuscito ➜ riepilogo aggiornato');
    e.target.reset();
  };
  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
