<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Prospetto Entrate & Uscite</title>

<!-- Tutto in un unico file; nessuna dipendenza esterna -->
<style>
:root{
  --line:28px;--lcol:#cdd7ee;--paper:#fbfcff;--ink:#1e293b;
  --green:#15803d;--red:#b91c1c;--lav:#d0d7e6;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Courier New",monospace}
body{
  padding:2rem 1rem;
  background:repeating-linear-gradient(var(--paper) 0 var(--line),
                                       var(--lcol) var(--line) calc(var(--line)+1px));
  color:var(--ink);
}
h1{text-align:center;margin-bottom:2rem;font-size:2rem;text-transform:uppercase;letter-spacing:1px}
.container{max-width:1200px;margin:0 auto}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
       gap:1rem;margin-bottom:2rem}
.card{background:#ffffffe6;border:1px solid #888;padding:1rem;border-radius:10px;
      text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.08);backdrop-filter:blur(2px)}
.card h3{font-size:0.9rem;margin-bottom:0.25rem}
.card p{font-size:1.4rem;font-weight:700}
.positive{color:var(--green)}.negative{color:var(--red)}

/* TABLES */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:2rem;background:#ffffffdd;
      border:1px solid #888;backdrop-filter:blur(2px)}
thead{background:#343434;color:#fff}
th,td{padding:0.55rem 0.6rem;text-align:center;font-size:0.9rem}
tbody tr:nth-child(even){background:#f1f5f9ee}
td.income{color:var(--green);font-weight:600}
td.expense{color:var(--red);font-weight:600}
td.balance{font-weight:700}
.balance.positive{color:var(--green)}
.balance.negative{color:var(--red)}
.month-sep td{background:var(--lav);font-weight:700;text-align:left;font-size:1rem;padding-left:0.4rem}
.badge{display:inline-block;padding:0.1rem 0.45rem;border-radius:4px;font-size:0.68rem;
       font-weight:700;color:#fff;text-transform:uppercase}
.badge.income{background:var(--green)}.badge.expense{background:var(--red)}
.sub-toggle{cursor:pointer}
.hidden{display:none}

/* FORM */
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
     gap:0.5rem;margin-bottom:2rem}
input,select,button{padding:0.35rem;border:1px solid #888;border-radius:4px;background:#fff7;font-family:inherit}
button{cursor:pointer;font-weight:700;background:var(--lav)}

/* Responsive extra-small */
@media(max-width:600px){
  th:nth-child(5),td:nth-child(5){display:none}      /* nascondi colonna Saldo nel dettaglio */
  th,td{font-size:0.78rem}
}
</style>
</head>
<body>
<h1>Prospetto Entrate &amp; Uscite</h1>
<div class="container">
  <section id="cards" class="cards"></section>

  <h2>Riepilogo Mensile</h2>
  <div class="table-wrap">
    <table id="monthly">
      <thead><tr><th>Mese</th><th>Entrate</th><th>Uscite</th><th>Saldo</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>Dettaglio</h2>
  <div class="table-wrap">
    <table id="detail">
      <thead><tr><th>Data</th><th>Categoria</th><th>Tipo</th><th>Importo</th><th>Saldo</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>Aggiungi transazione</h2>
  <form id="manual">
    <input type="date"   id="m-date" required>
    <input type="text"   id="m-cat"  placeholder="Categoria" required>
    <select id="m-type"><option>Entrata</option><option>Spesa</option></select>
    <input type="number" id="m-amt"  placeholder="€" step="1" required>
    <button>Inserisci</button>
  </form>
</div>

<script>
/*------------- UTIL -------------*/
const START_BALANCE = 6100;
const fmt = v => `€ ${Math.round(v).toLocaleString("it-IT")}`;
const mk  = d => d.slice(0,7);
const lastDay = (y,m)=>new Date(y,m+1,0).getDate();

/*------------- CATEGORIE ABBONAMENTI -------------*/
const subs = [
  "Netflix","Will","ChatGPT","NowTV","Spotify",
  "Prime Video AD","Prime","iCloud","YouTube+"
];
const subsSet = new Set(subs);      // per check veloce

/*---------------- DATASET FISSO ----------------*/
const subsData = [
  ["Netflix",19,26,"2025-06"],["Will",7,28,"2025-06"],["ChatGPT",23,22,"2025-06"],
  ["NowTV",5,19,"2025-07"],["Spotify",15,20,"2025-07"],["Prime Video AD",2,16,"2025-07"],
  ["Prime",5,16,"2025-07"],["iCloud",10,23,"2025-07"],["YouTube+",9,11,"2025-07"]
];
const oneOff = [
  ["2025-06-27","Aereo Sicilia",53,"Spesa"],
  ["2025-07-12","Beat Canzone",35,"Spesa"],
  ["2025-07-16","Mix Canzone",27,"Spesa"],
  ["2025-07-27","Aereo Sicilia",53,"Spesa"],
  ["2025-08-10","Rimborso 730",400,"Entrata"],
  ["2025-08-12","Beat Canzone",35,"Spesa"],
  ["2025-08-16","Mix Canzone",27,"Spesa"],
  ["2025-07-15","Tredicesima",1300,"Entrata"]
];
const loan = ["2025-07-01","2025-08-01","2025-09-01","2025-10-01"]
             .map(d=>[d,"Finanziamento",39,"Spesa"]);

/*---------------- COSTRUISCI TRANSAZIONI ----------------*/
let tx = [];
const push = (d,c,t,a) => tx.push({date:d,category:c,type:t,amount:a});

(function buildFixed(){
  oneOff.forEach(o=>push(...o));
  loan.forEach(o => push(...o));
  let cur = new Date(2025,5,24), end = new Date(2026,11,31);
  while(cur<=end){
    const y=cur.getFullYear(), m=cur.getMonth(), iso=`${y}-${String(m+1).padStart(2,"0")}`;
    if(cur>=new Date("2025-07-01")){
      push(`${iso}-01`,"Stipendio","Entrata",1650);
      push(`${iso}-01`,"Ticket Edenred","Entrata",160);
    }
    push(`${iso}-${lastDay(y,m)}`,"Affitto","Spesa",680);
    if(iso!=="2025-08") push(`${iso}-${lastDay(y,m)}`,"ATM","Spesa",39);
    [5,12,19,26].forEach(d=>{
      if(d<=lastDay(y,m)) push(`${iso}-${String(d).padStart(2,"0")}`,"Tabacco","Spesa",20);
    });
    subsData.forEach(([cat,amt,day,from])=>{
      if(iso>=from){
        const d=Math.min(day,lastDay(y,m));
        push(`${iso}-${String(d).padStart(2,"0")}`,cat,"Spesa",amt);
      }
    });
    cur.setMonth(m+1);
  }
})();

/*--------------- RENDER ---------------*/
function render(){
  const cardWrap=document.getElementById("cards");
  const mBody   =document.querySelector("#monthly tbody");
  const dBody   =document.querySelector("#detail tbody");
  cardWrap.innerHTML=''; mBody.innerHTML=''; dBody.innerHTML='';

  const sorted=[...tx].sort((a,b)=>new Date(a.date)-new Date(b.date));
  /* mappa mesi anche vuoti */
  const months={}, first=mk(sorted[0].date), last=mk(sorted[sorted.length-1].date);
  let it=new Date(first+"-01"), end=new Date(last+"-01");
  while(it<=end){
    months[mk(it.toISOString().slice(0,10))]={in:0,out:0,s:0};
    it.setMonth(it.getMonth()+1);
  }

  let bal=START_BALANCE;
  sorted.forEach(t=>{
    bal += t.type==='Entrata'?t.amount:-t.amount;
    t.balance=bal;
    const k=mk(t.date);
    if(t.type==='Entrata') months[k].in  += t.amount;
    else                   months[k].out += t.amount;
    months[k].s=bal;   // saldo dopo l'ultima operazione del mese
  });

  /* cards */
  const keys=Object.keys(months);
  const totIn = keys.reduce((s,k)=>s+months[k].in ,0);
  const totOut= keys.reduce((s,k)=>s+months[k].out,0);
  const avgOut= keys.length? Math.round(totOut/keys.length):0;
  [["Saldo iniziale",START_BALANCE],
   ["Entrate totali",totIn,"positive"],
   ["Uscite totali", totOut,"negative"],
   ["Spesa media mese",avgOut,"negative"],
   ["Saldo attuale",bal, bal>=0?'positive':'negative']]
  .forEach(([l,v,cls])=>{
    cardWrap.insertAdjacentHTML("beforeend",
      `<div class="card"><h3>${l}</h3><p class="${cls||''}">${fmt(v)}</p></div>`);
  });

  /* monthly */
  keys.forEach(k=>{
    const {in:inn,out,s}=months[k];
    mBody.insertAdjacentHTML("beforeend",
      `<tr><td>${k}</td><td class="income">${fmt(inn)}</td><td class="expense">${fmt(out)}</td><td class="balance ${s>=0?'positive':'negative'}">${fmt(s)}</td></tr>`);
  });

  /* detail + abbonamenti toggle */
  let curMonth='', subHeaderShown={};
  sorted.forEach(t=>{
    const mkd=mk(t.date);
    if(mkd!==curMonth){
      curMonth=mkd;
      subHeaderShown[curMonth]=false;
      const label=new Date(`${mkd}-01`).toLocaleDateString("it-IT",{month:'long',year:'numeric'});
      dBody.insertAdjacentHTML("beforeend",
        `<tr class="month-sep"><td colspan="5">${label.charAt(0).toUpperCase()+label.slice(1)}</td></tr>`);
    }
    if(subsSet.has(t.category)){
      if(!subHeaderShown[curMonth]){
        dBody.insertAdjacentHTML("beforeend",
          `<tr class="sub-toggle" data-month="${curMonth}">
             <td colspan="5">► Abbonamenti</td>
           </tr>`);
        subHeaderShown[curMonth]=true;
      }
      dBody.insertAdjacentHTML("beforeend",rowHTML(t,`subs-${curMonth} hidden`));
    }else{
      dBody.insertAdjacentHTML("beforeend",rowHTML(t));
    }
  });
}
function rowHTML(t,cls=''){return `<tr class="${cls}">
  <td>${t.date}</td>
  <td>${t.category}</td>
  <td><span class="badge ${t.type==='Entrata'?'income':'expense'}">${t.type}</span></td>
  <td class="${t.type==='Entrata'?'income':'expense'}">${fmt(t.amount)}</td>
  <td class="balance ${t.balance>=0?'positive':'negative'}">${fmt(t.balance)}</td>
</tr>`}
render();

/* toggle abbonamenti */
document.querySelector("#detail").addEventListener("click",e=>{
  const tr=e.target.closest(".sub-toggle");
  if(!tr) return;
  const m=tr.dataset.month;
  const rows=document.querySelectorAll(`.subs-${m}`);
  const isHidden=[...rows][0].classList.contains("hidden");
  rows.forEach(r=>r.classList.toggle("hidden",!isHidden));
  tr.firstChild.textContent=isHidden? "▼ Abbonamenti":"► Abbonamenti";
});

/* form manuale */
document.getElementById("manual").addEventListener("submit",e=>{
  e.preventDefault();
  const d=document.getElementById("m-date").value,
        c=document.getElementById("m-cat").value,
        t=document.getElementById("m-type").value,
        a=parseFloat(document.getElementById("m-amt").value);
  if(!d||!c||isNaN(a)) return;
  tx.push({date:d,category:c,type:t,amount:a});
  render();
  e.target.reset();
});
</script>
</body>
</html>
